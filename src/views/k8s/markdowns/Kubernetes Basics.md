# Kubernetes Basics

## Basic concepts

- Nodes
- Service:
    - permanent IP address
    - lifecycle of pod and service not connected
- ConfigMap: external configuration of your application, plain text, don’t put application credentials here
- Secrets: save credentials, base64 encoded format
- Volumes: persist data
- Cluster: group of nodes
- Ingress: route traffic to the cluster
- Deployment: for stateless applications
- StatefulSet: for stateful applications or databases
- Master: A node that configured to be the master node
- Components:
    - API server: Cung cấp API để giao diện, terminal tương tác với kubernetes cluster
    - etcd: Key-value store, nơi lưu trữ các thông tin cần thiết để vận hành cluster. Triển khai locks với master node để tránh xảy ra conflict
    - scheduler: Phân tải trên các node. Mỗi khi có container mới được tạo, scheduler sẽ assign nó cho node
    - controller: Nhận biết và xử lý khi gặp sự cố. Sẽ quyết định scale up/ scale down
    - container runtime: Docker
    - Kubelet: agent chạy trên mỗi node trong cluster

### Minikube

Installation

```yaml
brew install minikube
```

Start minikube

```yaml
minikube start --vm-driver=hyperkit
```

Get nodes

```yaml
kubectl get nodes

#NAME       STATUS   ROLES           AGE   VERSION
#minikube   Ready    control-plane   30s   v1.28.3
```

Check minikube status

```yaml
minikube status
```

Check `kubectl` version

```yaml
kubectl version
```

Basic commands:

![Untitled](Kubernetes%20Basics/Untitled.png)

Examples:

Create new nginx deployment:

```bash
kubectl create deployment nginx-depl --image=nginx
```

Edit the deployment file:

```bash
kubectl edit deployment nginx-depl 
```

Show all deployments:

```bash
kubectl get deployment
```

Show all pods:

```bash
kubectl get pod
```

Show deployment logs:

```bash
kubectl logs [deployment-name]
```

Show status of a pod:

```bash
kubectl describe pod [pod-name]
```

Exec command in pod

```bash
kubectl exec -it [pod-name] -- bin/bash
```

Delete the deployment, this will delete also pod, replicaset,…

```bash
kubectl delete deployment [deployment-name]
```

Example deployment template for nginx:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.16
          ports:
          - containerPort: 80
```

Apply the deployment configuration from deployment template:

```yaml
kubectl apply -f [deployment_template_path]
```

### Configuration files

Every k8s configuration files has 3 parts:

- Metadata
- Specification
- Status: auto generated by k8s

### Simple Nodejs Express + MongoDB app deployement

Create secret for mongodb, note that the value of secrets must be in base 64, cannot save in plain text. To convert plain text to base64 value:

```bash
echo -n 'some plain text' | base64
```

Secret template file

```yaml
apiVersion: v1
kind: Secret 
metadata: 
  name: mongodb-secret
type: Opaque 
data: 
  mongo-root-username: dXNlcm5hbWU= #username
  mongo-root-password: cGFzc3dvcmQ= #password
```

Config map template file:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-configmap
data:
  database_url: mongodb-service
```

Mongodb deployment template:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb-deployment
  labels:
    app: mongodb
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongodb 
  template:
    metadata:
      labels:
        app: mongodb 
    spec:
      containers:
        - name: mongodb 
          image: mongo
          ports:
          - containerPort: 27017
          env:
          - name: MONGO_INITDB_ROOT_USERNAME 
            valueFrom: 
              secretKeyRef: # Reference from Secrets 
                name: mongodb-secret
                key: mongo-root-username
          - name: MONGO_INITDB_ROOT_PASSWORD
            valueFrom: 
              secretKeyRef: 
                name: mongodb-secret
                key: mongo-root-password
# "---" Can be used to create multiple documents in one yaml file
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-service
spec:
  selector:
    app: mongodb 
  ports: 
    - protocol: TCP
      port: 27017
      targetPort: 27017
```

Mongo express deployment template:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata: 
  name: mongo-express
  labels: 
    app: mongo-express
spec:
  replicas: 1
  selector: 
    matchLabels:
      app: mongo-express
  template:
    metadata:
      labels:
        app: mongo-express
    spec:
      containers:
      - name: mongo-express
        image: mongo-express
        ports:
        - containerPort: 8081
        env:
        - name: ME_CONFIG_MONGODB_ADMINUSERNAME
          valueFrom:
            secretKeyRef: # Reference from Secrets
              name: mongodb-secret
              key: mongo-root-username
        - name: ME_CONFIG_MONGODB_ADMINPASSWORD
          valueFrom:
            secretKeyRef: 
              name: mongodb-secret
              key: mongo-root-password
        - name: ME_CONFIG_MONGODB_SERVER
          valueFrom:
            configMapKeyRef: # Reference from Configmap
              name: mongodb-configmap
              key: database_url

# "---" Can be used to create multiple documents in one yaml file
---
apiVersion: v1
kind: Service
metadata: 
  name: mongo-express-service
spec:
  selector:
    app: mongo-express
  type: LoadBalancer
  ports:
    - protocol: TCP
      port: 8081
      targetPort: 8081
      nodePort: 30000
```

Apply lần lượt các template trên: `Secrets` → `Configmap` → `Deployment & Services`

```yaml
kubectl apply -f [yaml file]
```

Hiển thị status của pod realtime

```yaml
kubectl get pod --watch
```

Assign external IP address to services

```yaml
minikube service [service name]
```

![Untitled](Kubernetes%20Basics/Untitled%201.png)
