# Kubernetes Basics

## Overview

- Containerize Application
- Chạy các service với dependencies trong container riêng của nó
- Container vs Virtual Machines

## Container orchestration

- Quản lý các containers, cho phép khả năng scale up/ scale down tuỳ thuộc vào lượng traffic.
- Giúp ứng dụng có tính sẵn sàng cao ( High availability)
- Các công nghệ tương tự:
    - Docker swarm
    - Mesos

## Basic concepts

- Nodes
- Service:
    - permanent IP address
    - lifecycle of pod and service not connected
- ConfigMap: external configuration of your application, plain text, don’t put application credentials here
- Secrets: save credentials, base64 encoded format
- Volumes: persist data
- Cluster: group of nodes
- Ingress: route traffic to the cluster
- Deployment: for stateless applications
- StatefulSet: for stateful applications or databases
- Master: A node that configured to be the master node
- Components:
    - API server: Cung cấp API để giao diện, terminal tương tác với kubernetes cluster
    - etcd: Key-value store, nơi lưu trữ các thông tin cần thiết để vận hành cluster. Triển khai locks với master node để tránh xảy ra conflict
    - scheduler: Phân tải trên các node. Mỗi khi có container mới được tạo, scheduler sẽ assign nó cho node
    - controller: Nhận biết và xử lý khi gặp sự cố. Sẽ quyết định scale up/ scale down
    - container runtime: Docker
    - Kubelet: agent chạy trên mỗi node trong cluster

### Minikube

Installation

```yaml
brew install minikube
```

Start minikube

```yaml
minikube start --vm-driver=hyperkit
```

Get nodes

```yaml
kubectl get nodes

#NAME       STATUS   ROLES           AGE   VERSION
#minikube   Ready    control-plane   30s   v1.28.3
```

Check minikube status

```yaml
minikube status
```

Check `kubectl` version

```yaml
kubectl version
```

Basic commands:

![Untitled](Kubernetes%20Basics%20f47e56bd0be840e3a271ec75d5e8a0b5/Untitled.png)

Examples:

Create new nginx deployment:

```bash
kubectl create deployment nginx-depl --image=nginx
```

Edit the deployment file:

```bash
kubectl edit deployment nginx-depl 
```

Show all deployments:

```bash
kubectl get deployment
```

Show all pods:

```bash
kubectl get pod
```

Show deployment logs:

```bash
kubectl logs [deployment-name]
```

Show status of a pod:

```bash
kubectl describe pod [pod-name]
```

Exec command in pod

```bash
kubectl exec -it [pod-name] -- bin/bash
```

Delete the deployment, this will delete also pod, replicaset,…

```bash
kubectl delete deployment [deployment-name]
```

Example deployment template for nginx:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:1.16
          ports:
          - containerPort: 80
```

Apply the deployment configuration from deployment template:

```yaml
kubectl apply -f [deployment_template_path]
```

### Configuration files

Every k8s configuration files has 3 parts:

- Metadata
- Specification
- Status: auto generated by k8s

### Simple Nodejs Express + MongoDB app deployement

Create secret for mongodb, note that the value of secrets must be in base 64, cannot save in plain text. To convert plain text to base64 value:

```bash
echo -n 'some plain text' | base64
```

Secret template file

```yaml
apiVersion: v1
kind: Secret 
metadata: 
  name: mongodb-secret
type: Opaque 
data: 
  mongo-root-username: dXNlcm5hbWU= #username
  mongo-root-password: cGFzc3dvcmQ= #password
```

Mongodb deployment template:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb-deployment
  labels:
    app: mongodb
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mongodb 
  template:
    metadata:
      labels:
        app: mongodb 
    spec:
      containers:
        - name: mongodb 
          image: mongo
          ports:
          - containerPort: 27017
          env:
          - name: MONGO_INITDB_ROOT_USERNAME 
            valueFrom: 
              secretKeyRef: 
                name: mongodb-secret
                key: mongo-root-username
          - name: MONGO_INITDB_ROOT_PASSWORD
            valueFrom: 
              secretKeyRef: 
                name: mongodb-secret
                key: mongo-root-password
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-service
spec:
  selector:
    app: mongodb 
  ports: 
    - protocol: TCP
      port: 27017
      targetPort: 27017
```

```yaml
kubectl get pod --watch
```